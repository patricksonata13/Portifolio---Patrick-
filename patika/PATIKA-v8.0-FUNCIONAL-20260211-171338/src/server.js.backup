import express from 'express';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import iaMock from './services/ia-mock.service.js';
import dindo from './services/dindo.service.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, '../public')));

console.log('ðŸš€ Inicializando PATIKA...');
iaMock.init();
console.log('âœ… Sistema pronto!\n');

// ========================================
// ROTAS PRINCIPAIS
// ========================================

app.get('/', (req, res) => {
  res.json({
    sistema: 'PATIKA',
    versao: '7.0.0',
    status: 'online',
    ia: `âœ… ${iaMock.getModeloAtivo()}`,
    modulos: ['chat', 'projetos', 'kika', 'dindo', 'automacao'],
    endpoints: [
      'GET /',
      'GET /api/status',
      'POST /api/chat',
      'GET /api/chat/historico',
      'GET /api/projetos',
      'GET /api/dindo/*',
      'GET /dashboard'
    ]
  });
});

app.get('/api/status', (req, res) => {
  res.json({
    ia: {
      ativo: iaMock.isReady(),
      modelo: iaMock.getModeloAtivo(),
      tipo: 'mock'
    },
    sistema: {
      versao: '7.0.0',
      uptime: Math.floor(process.uptime()),
      memoria: Math.floor(process.memoryUsage().heapUsed / 1024 / 1024) + 'MB'
    },
    estatisticas: {
      conversas: iaMock.getHistorico().length
    }
  });
});

// ========================================
// CHAT
// ========================================

app.post('/api/chat', async (req, res) => {
  const { mensagem } = req.body;
  
  if (!mensagem) {
    return res.status(400).json({ 
      sucesso: false, 
      erro: 'Campo "mensagem" obrigatÃ³rio' 
    });
  }
  
  const contexto = [
    'VocÃª Ã© PATIKA, assistente pessoal criado por Patrick Sonata.',
    'Ajude com roteiros, projetos criativos e organizaÃ§Ã£o.',
    'Seja conciso, Ãºtil e encorajador.'
  ];
  
  const resposta = await iaMock.perguntar(mensagem, contexto);
  res.json(resposta);
});

app.get('/api/chat/historico', (req, res) => {
  res.json({
    historico: iaMock.getHistorico(),
    total: iaMock.getHistorico().length
  });
});

app.post('/api/gemini/perguntar', async (req, res) => {
  const { pergunta } = req.body;
  
  if (!pergunta) {
    return res.status(400).json({ 
      sucesso: false, 
      erro: 'Campo "pergunta" obrigatÃ³rio' 
    });
  }
  
  const resposta = await iaMock.perguntar(pergunta);
  res.json(resposta);
});

// ========================================
// PROJETOS
// ========================================

app.get('/api/projetos', (req, res) => {
  res.json({
    projetos: [
      {
        id: 1,
        nome: 'CDD-3001',
        tipo: 'Universo Narrativo',
        status: 'Em desenvolvimento',
        descricao: 'SÃ©rie afrofuturista ambientada em 3001',
        tags: ['afrofuturismo', 'ficÃ§Ã£o cientÃ­fica', 'sÃ©rie'],
        progresso: 45
      },
      {
        id: 2,
        nome: 'O Postinho',
        tipo: 'SÃ©rie',
        status: 'Em desenvolvimento',
        descricao: 'ComÃ©dia sobre um posto de saÃºde',
        tags: ['comÃ©dia', 'sÃ©rie', 'cotidiano'],
        progresso: 30
      },
      {
        id: 3,
        nome: 'PATIKA',
        tipo: 'Metodologia',
        status: 'Ativo',
        descricao: 'Sistema pessoal de IA e organizaÃ§Ã£o',
        tags: ['ia', 'produtividade', 'sistema'],
        progresso: 70
      }
    ],
    total: 3,
    emDesenvolvimento: 2,
    ativos: 1
  });
});

// ========================================
// DINDO - FINANÃ‡AS
// ========================================

// TransaÃ§Ãµes
app.post('/api/dindo/transacao', (req, res) => {
  const transacao = dindo.adicionarTransacao(req.body);
  res.json({ sucesso: true, transacao });
});

app.get('/api/dindo/transacoes', (req, res) => {
  const transacoes = dindo.listarTransacoes(req.query);
  res.json({ transacoes, total: transacoes.length });
});

app.delete('/api/dindo/transacao/:id', (req, res) => {
  const removido = dindo.removerTransacao(req.params.id);
  res.json({ sucesso: removido });
});

// Resumo financeiro
app.get('/api/dindo/resumo', (req, res) => {
  const mes = req.query.mes;
  const resumo = dindo.getResumo(mes);
  res.json(resumo);
});

// Metas
app.post('/api/dindo/meta', (req, res) => {
  const meta = dindo.adicionarMeta(req.body);
  res.json({ sucesso: true, meta });
});

app.get('/api/dindo/metas', (req, res) => {
  const metas = dindo.listarMetas();
  res.json({ metas, total: metas.length });
});

app.put('/api/dindo/meta/:id', (req, res) => {
  const meta = dindo.atualizarMeta(req.params.id, req.body.valor);
  res.json({ sucesso: !!meta, meta });
});

app.delete('/api/dindo/meta/:id', (req, res) => {
  const removido = dindo.removerMeta(req.params.id);
  res.json({ sucesso: removido });
});

// SimulaÃ§Ãµes
app.post('/api/dindo/simular-investimento', (req, res) => {
  const resultado = dindo.simularInvestimento(req.body);
  res.json(resultado);
});

app.post('/api/dindo/simular-divida', (req, res) => {
  const resultado = dindo.simularDivida(req.body);
  res.json(resultado);
});

// EstatÃ­sticas
app.get('/api/dindo/stats', (req, res) => {
  const stats = dindo.getEstatisticas();
  res.json(stats);
});

// ========================================
// DASHBOARD
// ========================================

app.get('/dashboard', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/dashboard.html'));
});

// ========================================
// SERVIDOR
// ========================================

app.listen(PORT, () => {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                                               â•‘');
  console.log('â•‘                  ðŸŽ¬ PATIKA                    â•‘');
  console.log('â•‘         Seu Ecossistema Pessoal de IA        â•‘');
  console.log('â•‘              v7.0 Â· FUNCIONAL!               â•‘');
  console.log('â•‘                                               â•‘');
  console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
  console.log('â•‘                                               â•‘');
  console.log('â•‘   ðŸ¤– IA        â†’ âœ… PATIKA Mock v1.0         â•‘');
  console.log('â•‘   ðŸ’¬ CHAT      â†’ Inteligente e contextual    â•‘');
  console.log('â•‘   ðŸ“ PROJETOS  â†’ CDD-3001, Postinho, etc     â•‘');
  console.log('â•‘   ðŸ’° DINDO     â†’ FinanÃ§as e simulaÃ§Ãµes       â•‘');
  console.log('â•‘   ðŸŽ¯ STATUS    â†’ 100% Operacional            â•‘');
  console.log('â•‘                                               â•‘');
  console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
  console.log('â•‘                                               â•‘');
  console.log(`â•‘   ðŸ“ http://localhost:${PORT}                 â•‘`);
  console.log(`â•‘   ðŸ“Š Dashboard â†’ /dashboard                    â•‘`);
  console.log('â•‘   ðŸ’¬ Chat      â†’ POST /api/chat              â•‘');
  console.log('â•‘   ðŸ“‹ Projetos  â†’ GET /api/projetos           â•‘');
  console.log('â•‘   ðŸ’° DINDO     â†’ GET /api/dindo/stats        â•‘');
  console.log('â•‘                                               â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  console.log('ðŸ’¡ Novos endpoints DINDO disponÃ­veis!');
  console.log('   - POST /api/dindo/transacao');
  console.log('   - GET /api/dindo/resumo');
  console.log('   - POST /api/dindo/simular-investimento\n');
});

process.on('SIGINT', () => {
  console.log('\nâœ… PATIKA encerrado');
  process.exit(0);
});
